import { ConfigContext, ExpoConfig } from 'expo/config';

// Obter ambiente do processo ou padrão para desenvolvimento
const ENV = (process.env.APP_ENV || 'development') as 'development' | 'staging' | 'production';
const IS_DEV = ENV === 'development';
const IS_STAGING = ENV === 'staging';
const IS_PROD = ENV === 'production';

// Obter dados específicos do ambiente
const envConfig: Record<string, { apiUrl: string; firebaseConfig: string; sentryDsn: string }> = {
  development: {
    apiUrl: 'http://localhost:3000',
    firebaseConfig: './google-services.json',
    sentryDsn: process.env.SENTRY_DSN || 'https://example@sentry.io/123456',
  },
  staging: {
    apiUrl: 'https://staging-api.acucaradas.com.br',
    firebaseConfig: './google-services.json',
    sentryDsn: process.env.SENTRY_DSN || 'https://examplestaging@sentry.io/123456',
  },
  production: {
    apiUrl: 'https://api.acucaradas.com.br',
    firebaseConfig: './google-services.prod.json',
    sentryDsn: process.env.SENTRY_DSN || 'https://example@sentry.io/123456',
  },
};

// Configuração comum a todos os ambientes
const commonConfig: Partial<ExpoConfig> = {
  name: IS_PROD
    ? 'Açucaradas Encomendas'
    : `Açucaradas ${ENV.charAt(0).toUpperCase() + ENV.slice(1)}`,
  description: 'Aplicativo de encomendas de doces artesanais',
  slug: 'acucaradas-encomendas',
  privacy: 'unlisted',
  platforms: ['ios', 'android'],
  orientation: 'portrait',
  icon: './assets/icon.png',
  userInterfaceStyle: 'automatic',
  splash: {
    image: './assets/splash.png',
    resizeMode: 'contain',
    backgroundColor: '#ffffff',
  },
  updates: {
    fallbackToCacheTimeout: 0,
    url: 'https://u.expo.dev/6090106b-e327-4744-bce5-9ddb0d037045',
  },
  assetBundlePatterns: ['**/*'],
  ios: {
    supportsTablet: true,
    bundleIdentifier: 'com.acucaradas.encomendas',
    buildNumber: '1.0.0',
    infoPlist: {
      NSCameraUsageDescription:
        'Este aplicativo usa a câmera para escanear QR codes para pagamentos via PIX e para capturar fotos de avaliações de produtos.',
      NSPhotoLibraryUsageDescription:
        'Este aplicativo usa a biblioteca de fotos para selecionar imagens para avaliações de produtos.',
      NSPhotoLibraryAddUsageDescription:
        'Este aplicativo precisa de acesso para salvar imagens em sua galeria.',
      NSLocationWhenInUseUsageDescription:
        'Este aplicativo usa sua localização para sugerir endereços de entrega próximos.',
      NSMicrophoneUsageDescription:
        'Este aplicativo usa o microfone para permitir buscas por voz de produtos.',
      NSSpeechRecognitionUsageDescription:
        'Este aplicativo usa reconhecimento de fala para facilitar a busca de produtos por voz.'
    },
  },
  android: {
    package: 'com.acucaradas.encomendas',
    versionCode: 1,
    adaptiveIcon: {
      foregroundImage: './assets/adaptive-icon.png',
      backgroundColor: '#ffffff',
    },
    permissions: [
      'CAMERA',
      'READ_EXTERNAL_STORAGE',
      'WRITE_EXTERNAL_STORAGE',
      'ACCESS_FINE_LOCATION',
      'RECEIVE_BOOT_COMPLETED',
      'VIBRATE',
      'WAKE_LOCK',
      'INTERNET',
      'ACCESS_NETWORK_STATE',
      'RECORD_AUDIO',
    ],
    googleServicesFile: envConfig[ENV].firebaseConfig,
  },
  web: {
    favicon: './assets/favicon.png',
  },
  extra: {
    eas: {
      projectId: '6090106b-e327-4744-bce5-9ddb0d037045',
    },
    apiUrl: envConfig[ENV].apiUrl,
    sentryDsn: envConfig[ENV].sentryDsn,
    environment: ENV,
    enableSentryInDev: false,
    sentryDebug: IS_DEV,
    sentryTracesSampleRate: IS_PROD ? 0.2 : 1.0,
    stripePublishableKey: process.env.STRIPE_PUBLISHABLE_KEY || 'pk_test_sample',
    oneSignalAppId: process.env.ONESIGNAL_APP_ID || 'your-one-signal-app-id',
  },
  hooks: {
    postPublish: [
      {
        file: 'sentry-expo/upload-sourcemaps',
        config: {
          organization: 'acucaradas',
          project: 'acucaradas-app',
          authToken: process.env.SENTRY_AUTH_TOKEN,
        },
      },
    ],
  },
  plugins: [
    // 'sentry-expo', // Temporariamente removido para resolver erro de build
    [
      'expo-build-properties',
      {
        ios: {
          useFrameworks: 'static',
        },
        android: {
          compileSdkVersion: 34,
          targetSdkVersion: 34,
          buildToolsVersion: '34.0.0',
        },
      },
    ],
    [
      'expo-image-picker',
      {
        photosPermission:
          'O aplicativo acessa suas fotos para permitir que você compartilhe imagens nas avaliações de produtos.',
        cameraPermission:
          'O aplicativo acessa sua câmera para permitir que você tire fotos para avaliações de produtos.',
      },
    ],
    // [
    //   'onesignal-expo-plugin',
    //   {
    //     mode: IS_DEV ? 'development' : 'production',
    //   },
    // ],
   ],
};

export default ({ config }: ConfigContext): ExpoConfig => {
  // Versão do app
  const version = '1.0.0';

  return {
    ...commonConfig,
    version,
    ios: {
      ...commonConfig.ios,
      buildNumber: IS_PROD ? version : `${version}-${ENV}`,
    },
    android: {
      ...commonConfig.android,
      versionCode: IS_PROD ? 1 : IS_STAGING ? 10001 : 20001,
    },
  } as ExpoConfig;
};

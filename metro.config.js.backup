// Learn more https://docs.expo.io/guides/customizing-metro
const { getDefaultConfig } = require('@expo/metro-config');
const path = require('path');

/** @type {import('@expo/metro-config').MetroConfig} */
const config = getDefaultConfig(__dirname);

// Configurações adicionais para resolver problemas do Metro Bundler
config.resolver.assetExts = [...config.resolver.assetExts, 'cjs'];
config.resolver.sourceExts = [...config.resolver.sourceExts, 'jsx', 'ts', 'tsx'];

// Limitar o número de workers para evitar sobrecarga em sistemas com recursos limitados
config.maxWorkers = 2;

// Configurar aliases para resolver problemas de módulos
config.resolver.extraNodeModules = {
  'expo-router': path.resolve(__dirname, 'node_modules/expo-router'),
  '@expo/metro-runtime': path.resolve(__dirname, 'node_modules/@expo/metro-runtime'),
  'react': path.resolve(__dirname, 'node_modules/react'),
  'react-dom': path.resolve(__dirname, 'node_modules/react-dom'),
  'react-native': path.resolve(__dirname, 'node_modules/react-native'),
  'metro': path.resolve(__dirname, 'node_modules/metro'),
  'metro-config': path.resolve(__dirname, 'node_modules/metro-config'),
  'metro-core': path.resolve(__dirname, 'node_modules/metro-core'),
  'metro-runtime': path.resolve(__dirname, 'node_modules/metro-runtime'),
  'metro-resolver': path.resolve(__dirname, 'node_modules/metro-resolver'),
  '@types/react': path.resolve(__dirname, 'node_modules/@types/react'),
  'firebase': path.resolve(__dirname, 'node_modules/firebase'),
  'react-native-reanimated': path.resolve(__dirname, 'node_modules/react-native-reanimated'),
  'react-native-gesture-handler': path.resolve(__dirname, 'node_modules/react-native-gesture-handler'),
  'react-native-screens': path.resolve(__dirname, 'node_modules/react-native-screens'),
  'scheduler': path.resolve(__dirname, 'node_modules/scheduler'),
  'react-is': path.resolve(__dirname, 'node_modules/react-is'),
};

// Configurar watchFolders para incluir node_modules
config.watchFolders = [
  path.resolve(__dirname, 'node_modules')
];

// Desativar Watchman para evitar problemas no Windows
config.resolver.useWatchman = false;

// Configurações para melhorar a resolução de módulos
config.resolver.disableHierarchicalLookup = true;
config.resolver.nodeModulesPaths = [path.resolve(__dirname, 'node_modules')];

// Forçar reset do cache para evitar problemas de watch
config.resetCache = true;


// Resolver personalizado para corrigir problemas com expo-router
config.resolver.resolveRequest = (context, moduleName, platform) => {
  // Corrigir problema específico com expo-router/entry.bundle
  if (moduleName.includes('expo-router') && moduleName.includes('entry.bundle')) {
    return {
      filePath: path.resolve(__dirname, 'node_modules/expo-router/entry.js'),
      type: 'sourceFile',
    };
  }
  // Usar resolução padrão para outros módulos
  return context.resolveRequest(context, moduleName, platform);
};

// Configurar aliases para resolver problemas de módulos
config.resolver.extraNodeModules = {
  'expo-router': path.resolve(__dirname, 'node_modules/expo-router'),
  '@expo/metro-runtime': path.resolve(__dirname, 'node_modules/@expo/metro-runtime'),
  'react': path.resolve(__dirname, 'node_modules/react'),
  'react-native': path.resolve(__dirname, 'node_modules/react-native'),
};

// Configurar watchFolders para incluir node_modules
config.watchFolders = [
  path.resolve(__dirname, 'node_modules')
];
module.exports = config;
